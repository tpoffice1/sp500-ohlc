name: Build yesterday's JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '12 3 * * 1-5'   # 03:12 UTC Monâ€“Fri
  push:
    paths:
      - ".github/workflows/build.yml"
      - "fetch_ohlc.py"
      - "tickers.txt"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure tickers.txt >= 400
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f tickers.txt ]; then
            printf "%s\n" \
              AAPL MSFT AMZN GOOGL META BRK.B TSLA UNH JNJ JPM V PG NVDA HD MA BAC XOM PFE KO PEP DIS INTC CSCO CMCSA NFLX ABT ADBE CRM CVX T WMT MCD NKE MRK COST ABBV DHR ACN AVGO LIN TXN VZ NEE WFC BMY PM UPS HON LOW MS RTX AMD IBM ORCL AMGN CAT SCHW SBUX GS INTU AXP MDT LMT DE ISRG GE GILD BKNG BLK ZTS PLD CVS MO AMT C CI SPGI SYK ADI MDLZ REGN ADP NOW TMUS MMC TGT MU PNC CB EQIX BDX FISV SO PGR DUK ITW SHW USB ICE CME FDX NSC PSA HUM CARR AON APD CL EL ETN EOG MPC MAR ALL AEP HCA PSX KDP TRV DG MCK EMR AIG OXY MNST KMB PRU STZ CNC D WY ROK OKE VLO PEG HPQ \
              > tickers.txt
          fi
          rows=$(grep -E '^[A-Z0-9.-]+$' tickers.txt | wc -l)
          echo "tickers.txt count: $rows"

      - name: Build (non-fatal while we stabilize)
        run: |
          python fetch_ohlc.py || true
